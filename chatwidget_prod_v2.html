<div id="widget-container"></div>
<script>
    // Error handling utility
    function logError(context, error, details = {}) {
        console.error(`[${context}] Error:`, error);
        if (Object.keys(details).length > 0) {
            console.error(`[${context}] Details:`, details);
        }
    }

    function getUrlParameter(name) {
        try {
            if (!name || typeof name !== 'string') {
                throw new Error('Parameter name must be a non-empty string');
            }
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        } catch (error) {
            logError('getUrlParameter', error, { paramName: name });
            return null;
        }
    }

    function saveJwtToStorage(jwt) {
        try {
            if (!jwt || typeof jwt !== 'string') {
                throw new Error('JWT must be a non-empty string');
            }
            if (typeof Storage === 'undefined') {
                throw new Error('LocalStorage is not supported in this browser');
            }
            localStorage.setItem('chat_token', jwt);
            return true;
        } catch (error) {
            logError('saveJwtToStorage', error, { jwt: jwt ? 'provided' : 'missing' });
            return false;
        }
    }

    function getJwtFromStorage() {
        try {
            if (typeof Storage === 'undefined') {
                console.warn('LocalStorage is not supported in this browser');
                return null;
            }
            return localStorage.getItem('chat_token');
        } catch (error) {
            logError('getJwtFromStorage', error);
            return null;
        }
    }

    function isJwtValid(jwt) {
        try {
            if (!jwt || typeof jwt !== 'string') {
                return false;
            }

            const parts = jwt.split('.');
            if (parts.length !== 3) {
                throw new Error('JWT must have 3 parts separated by dots');
            }

            // Decode base64 payload with proper padding
            let payload = parts[1];
            // Add padding if necessary
            while (payload.length % 4) {
                payload += '=';
            }

            const decodedPayload = JSON.parse(atob(payload));

            if (!decodedPayload.exp || typeof decodedPayload.exp !== 'number') {
                console.warn('JWT does not contain valid expiration time');
                return false;
            }

            const currentTime = Math.floor(Date.now() / 1000);
            const isValid = decodedPayload.exp > currentTime;

            return isValid;
        } catch (error) {
            logError('isJwtValid', error, { jwtProvided: !!jwt });
            return false;
        }
    }

    // Funktion zum Testen ob ETP aktiv ist (Enhanced Tracking Protection)
    async function testETPActive() {
        const ua = navigator.userAgent;
        const isFirefox = ua.includes("Firefox");
        const isEdge = ua.includes("Edg/");

        // Ergebnis-Flags
        let firefoxStrict = false;
        let edgeTrackingPrevention = false;

    // ---------- FIREFOX TEST ----------
    if (isFirefox) {
        // Test: Zendesk-Ressource laden - unterscheide zwischen HTTP-Fehler (OK) und Network-Fehler (ETP)
        try {
            const response = await fetch("https://avm.zendesk.com/embeddable/config", {
                method: "GET",
                cache: "no-store"
            });
            // Wenn Response vorhanden (auch bei 404/403) → Anfrage kam durch, ETP ist NICHT aktiv
        } catch (error) {
            // Prüfe die Fehlermeldung
            const errorMsg = error.message || '';
            
            // "NetworkError when attempting to fetch resource." = ETP blockiert
            // HTTP-Status-Fehler (404, 403, etc.) werfen keinen Fehler, sondern geben Response zurück
            if (errorMsg.includes('NetworkError') || errorMsg.includes('network')) {
                console.warn('Firefox: NetworkError detected - ETP is active');
                firefoxStrict = true;
            }
        }
    }

    // ---------- EDGE TEST ----------
    if (isEdge) {
        // Test: Zendesk-Ressource laden - unterscheide zwischen HTTP-Fehler (OK) und Network-Fehler (ETP)
        try {
            const response = await fetch("https://static.zdassets.com/ekr/sentry-browser.min.js", {
                method: "GET",
                cache: "no-store"
            });
            // Wenn Response vorhanden (auch bei 404/403) → Anfrage kam durch, ETP ist NICHT aktiv
        } catch (error) {
            // Prüfe die Fehlermeldung
            const errorMsg = error.message || '';
            
            // "Failed to fetch" = ETP blockiert
            // HTTP-Status-Fehler (404, 403, etc.) werfen keinen Fehler, sondern geben Response zurück
            if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                console.warn('Edge: Failed to fetch detected - ETP is active');
                edgeTrackingPrevention = true;
            }
        }
    }        // ---------- AUSWERTUNG ----------
        if (firefoxStrict || edgeTrackingPrevention) {
            console.warn("⚠️ Erhöhte Tracking-Protection erkannt - Zendesk Widget kann nicht geladen werden.");
            showETPWarning();
            return true; // ETP ist aktiv
        }

        return false; // ETP ist nicht aktiv
    }

    // Funktion zum Anzeigen einer ETP-Warnung
    function showETPWarning() {
        const container = document.getElementById('widget-container');
        if (!container) return;

        // Browser erkennen
        const isFirefox = navigator.userAgent.toLowerCase().includes('firefox');
        const isEdge = navigator.userAgent.toLowerCase().includes('edg');

        // Browser-spezifische Anleitung
        let instruction = '';
        if (isFirefox) {
            instruction = 'Klicken Sie auf das <strong>Schild-Symbol</strong> in der Adressleiste und deaktivieren Sie den "Verbesserten Tracking-Schutz" für diese Website.';
        } else if (isEdge) {
            instruction = 'Klicken Sie auf das <strong>Schloss-Symbol</strong> in der Adressleiste und deaktivieren Sie "Verhinderung der Nachverfolgung für diese Website".';
        } else {
            // Fallback für andere Browser
            instruction = 'Bitte deaktivieren Sie den Tracking-Schutz in Ihren Browser-Einstellungen für diese Website.';
        }

        container.innerHTML = `
                <div id="etp-warning-box" style="
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    max-width: 400px;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    padding: 24px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    z-index: 999999;
                    border: 2px solid #ff6b6b;
                ">
                    <button onclick="document.getElementById('etp-warning-box').remove()" style="
                        position: absolute;
                        top: 12px;
                        right: 12px;
                        background: transparent;
                        border: none;
                        color: #999;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        line-height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">×</button>
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <div style="
                            background: #ff6b6b;
                            color: white;
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            flex-shrink: 0;
                            padding-bottom: 5px;
                        ">⚠</div>
                        <div style="flex: 1; padding-right: 12px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 18px; color: #333;">
                                Live-Chat nicht verfügbar
                            </h3>
                            <p style="margin: 0 0 12px 0; font-size: 14px; color: #666; line-height: 1.5;">
                                Der Live-Chat kann aufgrund Ihrer Browser-Einstellungen nicht geladen werden.
                            </p>
                            <div style="font-size: 13px; color: #666; margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; line-height: 1.6;">
                                <div style="font-weight: 600; margin-bottom: 8px;">So aktivieren Sie den Chat:</div>
                                ${instruction}
                            </div>
                            <button onclick="location.reload()" style="
                                background: #0089D1;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                width: 100%;
                            ">
                                Nach Anpassung neu laden
                            </button>
                        </div>
                    </div>
                </div>
            `;
    }

    function loadZendeskWidget(jwt) {
        return new Promise(async (resolve, reject) => {
            try {
                if (!jwt) {
                    throw new Error('JWT is required for Zendesk widget');
                }

                // Zuerst testen ob ETP aktiv ist
                const etpActive = await testETPActive();

                if (etpActive) {
                    console.warn('ETP is active - Zendesk will likely be blocked, showing warning');
                    showETPWarning();
                    reject(new Error('ETP is blocking tracking scripts'));
                    return;
                }


                // Check if Zendesk script is already loaded
                const existingScript = document.getElementById('ze-snippet');
                if (existingScript) {
                    existingScript.remove();
                }

                const script = document.createElement('script');
                script.id = 'ze-snippet';
                script.src = 'https://static.zdassets.com/ekr/snippet.js?key=46408885-a302-4a77-a8f1-0ed67a5ec805';

                // Set timeout for script loading
                const timeout = setTimeout(() => {
                    console.warn('Zendesk script loading timeout - might be ETP');
                    showETPWarning();
                    reject(new Error('Zendesk script loading timeout'));
                }, 10000); // 10 seconds timeout

                script.onload = function () {
                    clearTimeout(timeout);

                    // Wait for zE to be available
                    const checkZE = setInterval(() => {
                        if (typeof zE !== 'undefined') {
                            clearInterval(checkZE);

                            try {
                                zE("messenger", "loginUser",
                                    function jwtCallback(callback) {
                                        callback(jwt);
                                        zE('messenger', 'open');

                                        // Zusätzliche Prüfung: Warte kurz und prüfe ob Messenger wirklich funktioniert
                                        setTimeout(() => {
                                            try {
                                                // Versuche den Status abzufragen
                                                zE('messenger:on', 'open', function () {
                                                });
                                                resolve();
                                            } catch (e) {
                                                console.warn('Zendesk messenger might be blocked:', e);
                                                showETPWarning();
                                                reject(new Error('Zendesk messenger blocked'));
                                            }
                                        }, 2000);
                                    },
                                    function loginCallback(error) {
                                        if (error) {
                                            const { type, reason, message } = error;
                                            const errorMsg = `Login failed: ${type} - ${reason} - ${message}`;
                                            logError('Zendesk Login', new Error(errorMsg), error);
                                            showETPWarning();
                                            reject(new Error(errorMsg));
                                        }
                                    }
                                );
                            } catch (zeError) {
                                logError('Zendesk zE function', zeError);
                                showETPWarning();
                                reject(zeError);
                            }
                        }
                    }, 100);

                    // Timeout for zE availability
                    setTimeout(() => {
                        clearInterval(checkZE);
                        if (typeof zE === 'undefined') {
                            console.warn('Zendesk zE not available - likely ETP');
                            showETPWarning();
                            reject(new Error('Zendesk zE function not available after timeout'));
                        }
                    }, 5000);
                };

                script.onerror = function (event) {
                    clearTimeout(timeout);
                    const error = new Error('Failed to load Zendesk Widget script');
                    logError('Zendesk Script Loading', error, { event });
                    showETPWarning();
                    reject(error);
                };

                document.head.appendChild(script);
            } catch (error) {
                logError('loadZendeskWidget', error);
                showETPWarning();
                reject(error);
            }
        });
    }

    function loadBotarioWidget() {
        return new Promise((resolve, reject) => {
            try {
                const container = document.getElementById('widget-container');
                if (!container) {
                    throw new Error('Widget container not found');
                }

                // Clear any existing content
                container.innerHTML = '';

                // Create botario chat element
                container.innerHTML = '<botario-chat bot-id="68c039dccf68cc7cca6faf92" api-url="https://gpt.avm.botario.com/static/chat-client/"></botario-chat>';

                // Load main widget script
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'https://gpt.avm.botario.com/static/chat-widget/chat-widget.js';

                script.onload = function () {
                    resolve();
                };

                script.onerror = function (event) {
                    const error = new Error('Failed to load Botario Widget script');
                    logError('Botario Script Loading', error, { event });
                    reject(error);
                };

                document.head.appendChild(script);
            } catch (error) {
                logError('loadBotarioWidget', error);
                reject(error);
            }
        });
    }

    // Funktion zum Wechseln von Botario zu Zendesk
    async function switchToZendesk() {
        try {

            // Zuerst prüfen ob ETP aktiv ist, BEVOR das Widget geladen wird
            const etpActive = await testETPActive();

            if (etpActive) {
                console.warn('ETP is active - cannot load Zendesk, showing warning');
                // Botario Widget ausblenden, aber nur wenn keine ETP-Warnung angezeigt werden soll
                const container = document.getElementById('widget-container');
                if (container) {
                    container.style.display = 'none';
                }
                showETPWarning();
                // Container wieder einblenden für ETP-Warnung
                if (container) {
                    container.style.display = 'block';
                }
                return;
            }


            // Botario Widget ausblenden
            const container = document.getElementById('widget-container');
            if (container) {
                container.style.display = 'none';
            }

            // JWT holen
            const jwt = getJwtFromStorage();

            if (!jwt || !isJwtValid(jwt)) {
                throw new Error('No valid JWT found. Cannot switch to Zendesk.');
            }

            // Zendesk Widget laden
            await loadZendeskWidget(jwt);
            
            // Alle botario-bezogenen sessionStorage Einträge entfernen
            
            const keysToRemove = [];
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith('botario')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => {
                sessionStorage.removeItem(key);
            });
            

        } catch (error) {
            logError('switchToZendesk', error);
            // Bei Fehler NICHT Botario wieder einblenden, wenn ETP-Warnung angezeigt wird
            const container = document.getElementById('widget-container');
            if (container && !container.innerHTML.includes('Live-Chat nicht verfügbar')) {
                container.style.display = 'block';
            }
        }
    }

    // Funktion zum Hinzufügen des Click-Listeners im Shadow Root
    function addShadowRootClickListener(shadowRoot) {
        try {
            // Click-Listener für das gesamte Shadow Root
            shadowRoot.addEventListener('click', function (event) {
                // Prüfen ob das geklickte Element ein Link mit dem Text "Zum Livechat" ist
                if (event.target.tagName === 'A' &&
                    event.target.textContent.trim() === 'Zum Livechat') {


                    // Verhindere Standard-Link-Verhalten
                    event.preventDefault();

                    // JWT aus dem href extrahieren
                    const href = event.target.href;

                    try {
                        // URL parsen um Query-Parameter zu extrahieren
                        const url = new URL(href);
                        const jwtFromLink = url.searchParams.get('jwt');

                        if (jwtFromLink) {
                            saveJwtToStorage(jwtFromLink);

                            // Validiere das JWT
                            if (isJwtValid(jwtFromLink)) {
                                switchToZendesk();
                            } else {
                                alert('Der Link ist abgelaufen oder ungültig. Bitte kontaktieren Sie den Support.');
                            }
                        } else {
                            // Versuche trotzdem mit gespeichertem JWT
                            switchToZendesk();
                        }
                    } catch (urlError) {
                        logError('JWT extraction from link', urlError);
                        // Fallback: Versuche mit gespeichertem JWT
                        switchToZendesk();
                    }

                    return;
                }
            }, true);

        } catch (error) {
            logError('addShadowRootClickListener', error);
        }
    }

    async function initializeWidget() {
        try {

            // Check for JWT in URL
            const jwtFromUrl = getUrlParameter('jwt');

            if (jwtFromUrl) {
                saveJwtToStorage(jwtFromUrl);

                if (isJwtValid(jwtFromUrl)) {
                    try {
                        await loadZendeskWidget(jwtFromUrl);
                        return;
                    } catch (error) {
                        logError('Zendesk Widget Fallback', error);
                        // Wenn ETP-Warnung angezeigt wird, NICHT zu Botario fallback
                        const container = document.getElementById('widget-container');
                        if (container && container.innerHTML.includes('Live-Chat nicht verfügbar')) {
                            return;
                        }
                    }
                }
            }

            // Check for JWT in storage
            const jwtFromStorage = getJwtFromStorage();

            if (jwtFromStorage && isJwtValid(jwtFromStorage)) {
                try {
                    await loadZendeskWidget(jwtFromStorage);
                    return;
                } catch (error) {
                    logError('Zendesk Widget Fallback', error);
                    // Wenn ETP-Warnung angezeigt wird, NICHT zu Botario fallback
                    const container = document.getElementById('widget-container');
                    if (container && container.innerHTML.includes('Live-Chat nicht verfügbar')) {
                        return;
                    }
                }
            }

            // Fallback to Botario widget
            setTimeout(async () => {
                await loadBotarioWidget();

                
            }, 4000);

        } catch (error) {
            logError('Widget Initialization', error);
            console.error('Failed to initialize any widget. Please refresh the page.');
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWidget);
    } else {
        initializeWidget();
    }

</script>
<script>
    // CSS als String definieren
    const customCSS = `
        #chat-container {
            z-index: 99999 !important;
        }
        app-chat-header img{
            background-color: transparent !important;
        }
        
        /* Chat Badge Animation - Heartbeat */
        app-chat-badge {
            transform-origin: center center !important;
        }
        
        app-chat-badge.heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite !important;
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.2); }
            28% { transform: scale(1); }
            42% { transform: scale(1.2); }
            70% { transform: scale(1); }
        }
    `;

    // CSS für die externe Tooltip (außerhalb Shadow DOM) - Speech Bubble Style
    const externalTooltipCSS = `
        .external-chat-tooltip {
            position: fixed !important;
            background: linear-gradient(135deg, #0089D1 0%, #006ba1 100%) !important;
            color: white !important;
            padding: 18px 24px !important;
            border-radius: 25px 25px 0 25px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            opacity: 0 !important;
            transform: translateY(10px) scale(0.95) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            pointer-events: none !important;
            z-index: 999999 !important;
            box-shadow: 0 8px 30px rgba(0, 137, 209, 0.4) !important;
            max-width: 200px !important;
        }
        
        .external-chat-tooltip::after {
            content: '' !important;
            position: absolute !important;
            bottom: -10px !important;
            right: 20px !important;
            width: 0 !important;
            height: 0 !important;
            border-right: 20px solid transparent !important;
            border-top: 20px solid #006ba1 !important;
        }
        
        .external-chat-tooltip.show {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }
    `;

    // Funktion zum Überprüfen ob es sich um ein mobiles Gerät handelt
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            window.innerWidth <= 768;
    }

    // Funktion zum Erstellen der externen Tooltip-Styles
    function createExternalTooltipStyles() {
        if (document.querySelector('#external-tooltip-styles')) {
            return;
        }

        const style = document.createElement('style');
        style.id = 'external-tooltip-styles';
        style.textContent = externalTooltipCSS;
        document.head.appendChild(style);
    }

    // Funktion zum Berechnen der Badge Position
    function getBadgePosition(chatBadge) {
        const rect = chatBadge.getBoundingClientRect();
        return {
            top: rect.top,
            right: window.innerWidth - rect.right,
            bottom: rect.bottom,
            left: rect.left,
            width: rect.width,
            height: rect.height
        };
    }

    // Funktion zum Erstellen der externen Tooltip
    function createExternalTooltip() {
        let tooltip = document.querySelector('#external-chat-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'external-chat-tooltip';
            tooltip.className = 'external-chat-tooltip';
            tooltip.textContent = 'Darf ich dir behilflich sein?';
            document.body.appendChild(tooltip);
        }
        return tooltip;
    }

    // Funktion zum Positionieren der externen Tooltip
    function positionExternalTooltip(tooltip, chatBadge) {
        const badgePos = getBadgePosition(chatBadge);

        // Tooltip erst unsichtbar machen für Größenmessung
        tooltip.style.visibility = 'hidden';
        tooltip.style.display = 'block';

        // Höhe der Tooltip messen
        const tooltipHeight = tooltip.offsetHeight;

        // Position oberhalb des Badges berechnen - dynamisch basierend auf Tooltip-Höhe
        const topPosition = badgePos.top - tooltipHeight - 15; // 15px Abstand zum Badge

        // Tooltip positionieren
        tooltip.style.top = topPosition + 'px';
        tooltip.style.right = (badgePos.right - 10) + 'px';

        // Tooltip wieder sichtbar machen
        tooltip.style.visibility = 'visible';
        tooltip.style.display = 'block';
    }

    // Funktion zum Hinzufügen der Tooltip-Animation
    function addTooltipToChatBadge(shadowRoot, chatBadge) {
        // Externe Styles erstellen
        createExternalTooltipStyles();

        // Suche das gesamte Badge Element (app-chat-badge)
        const badgeElement = shadowRoot.querySelector('app-chat-badge') || chatBadge;

        // Externe Tooltip erstellen
        const tooltip = createExternalTooltip();

        // Animation starten
        function startShakeAnimation() {
            if (!badgeElement.classList.contains('heartbeat')) {
                // Badge Position berechnen und Tooltip positionieren
                positionExternalTooltip(tooltip, badgeElement);

                // Animationen starten
                badgeElement.classList.add('heartbeat');
                tooltip.classList.add('show');

                // Animation nach 3 Sekunden stoppen
                setTimeout(() => {
                    badgeElement.classList.remove('heartbeat');
                    tooltip.classList.remove('show');
                }, 3000);
            }
        }

        // Position bei Resize aktualisieren
        window.addEventListener('resize', () => {
            if (tooltip.classList.contains('show')) {
                positionExternalTooltip(tooltip, badgeElement);
            }
        });

        // Erste Animation nach 5 Sekunden
        setTimeout(startShakeAnimation, 5000);

        // Dann alle 5 Sekunden wiederholen
        setInterval(startShakeAnimation, 30000);
    }

    // Funktion zum Einfügen von CSS in Shadow DOM
    function injectCSSIntoShadowRoot(shadowRoot, cssString) {
        try {
            // Prüfen ob bereits injiziert
            if (shadowRoot.querySelector('#custom-chat-styles')) {
                return;
            }

            const style = document.createElement('style');
            style.id = 'custom-chat-styles';
            style.textContent = cssString;
            shadowRoot.appendChild(style);

        } catch (error) {
            console.error('Failed to inject CSS into Shadow DOM:', error);
        }
    }

    // Funktion zum Verarbeiten des Chat Elements
    function processChatElement() {
        const chatElement = document.querySelector('botario-chat');

        if (chatElement && chatElement.shadowRoot) {
            const shadowRoot = chatElement.shadowRoot;

            // CSS in Shadow DOM einfügen
            injectCSSIntoShadowRoot(shadowRoot, customCSS);

            // Click-Listener zum Shadow Root hinzufügen
            addShadowRootClickListener(shadowRoot);

            // Direkt prüfen, ob schon vorhanden
            let container = shadowRoot.querySelector('#chat-container');
            let chatBadge = shadowRoot.querySelector('#chat-badge');

            // Chat Badge nur auf Desktop automatisch öffnen
            if (chatBadge && !isMobileDevice()) {
                chatBadge.click();
            }

            // Auf mobilen Geräten Tooltip-Animation hinzufügen
            if (chatBadge && isMobileDevice()) {
                addTooltipToChatBadge(shadowRoot, chatBadge);
            }

            if (!container || !chatBadge) {
                // Sonst auf spätere Mutationen warten
                const observer = new MutationObserver((mutations, obs) => {
                    // CSS bei jeder Mutation neu injizieren (falls DOM neu aufgebaut wird)
                    injectCSSIntoShadowRoot(shadowRoot, customCSS);

                    if (!chatBadge) {
                        chatBadge = shadowRoot.querySelector('#chat-badge');
                        if (chatBadge) {
                            // Chat Badge nur auf Desktop automatisch öffnen
                            if (!isMobileDevice()) {
                                chatBadge.click();
                            } else {
                                // Auf mobilen Geräten Tooltip-Animation hinzufügen
                                addTooltipToChatBadge(shadowRoot, chatBadge);
                            }
                        }
                    }

                    // Beobachtung stoppen wenn beide Elemente gefunden wurden
                    if (container && chatBadge) {
                        obs.disconnect();
                    }
                });

                observer.observe(shadowRoot, { childList: true, subtree: true });
            }
        } else {

            // Kombiniere MutationObserver mit Polling als Fallback
            const chatObserver = new MutationObserver((mutations, obs) => {
                const chatElement = document.querySelector('botario-chat');
                if (chatElement && chatElement.shadowRoot) {
                    obs.disconnect();
                    clearInterval(pollInterval);
                    setTimeout(processChatElement, 100);
                }
            });

            chatObserver.observe(document.getElementById('widget-container') || document.body, { childList: true, subtree: true });

            // Zusätzlich Polling als Fallback
            const pollInterval = setInterval(() => {
                const chatElement = document.querySelector('botario-chat');
                if (chatElement && chatElement.shadowRoot) {
                    chatObserver.disconnect();
                    clearInterval(pollInterval);
                    setTimeout(processChatElement, 100);
                }
            }, 500);

            // Nach 20 Sekunden aufgeben
            setTimeout(() => {
                chatObserver.disconnect();
                clearInterval(pollInterval);
            }, 20000);
        }
    }

    // Sofort ausführen
    processChatElement();
</script>